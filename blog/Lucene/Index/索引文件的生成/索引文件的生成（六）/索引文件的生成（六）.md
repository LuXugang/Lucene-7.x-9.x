# [ç´¢å¼•æ–‡ä»¶çš„ç”Ÿæˆï¼ˆå…­ï¼‰](https://www.amazingkoala.com.cn/Lucene/Index/)

&emsp;&emsp;æœ¬æ–‡æ‰¿æ¥[ç´¢å¼•æ–‡ä»¶çš„ç”Ÿæˆï¼ˆäº”ï¼‰](https://www.amazingkoala.com.cn/Lucene/Index/2020/0110/125.html)ç»§ç»­ä»‹ç»å‰©ä½™çš„å†…å®¹ï¼Œä¸‹é¢å…ˆç»™å‡ºç”Ÿæˆç´¢å¼•æ–‡ä»¶.timã€.tipçš„æµç¨‹å›¾ã€‚

## ç”Ÿæˆç´¢å¼•æ–‡ä»¶.timã€.tipçš„æµç¨‹å›¾
å›¾1ï¼š

<img src="ç´¢å¼•æ–‡ä»¶çš„ç”Ÿæˆï¼ˆå…­ï¼‰-image/1.png">

&emsp;&emsp;ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†æ‰§è¡Œ`ç”Ÿæˆä¸€ä¸ªæˆ–å¤šä¸ªNodeBlock`çš„è§¦å‘æ¡ä»¶ï¼Œæœ¬æ–‡å°±å…¶å®ç°è¿‡ç¨‹å±•å¼€ä»‹ç»ï¼ŒåŒæ ·çš„ï¼Œä¸‹æ–‡ä¸­å‡ºç°çš„å¹¶ä¸”æ²¡æœ‰ä½œå‡ºè§£é‡Šçš„åè¯ï¼Œè¯´æ˜å·²ç»åœ¨æ–‡ç« [ç´¢å¼•æ–‡ä»¶çš„ç”Ÿæˆï¼ˆäº”ï¼‰](https://www.amazingkoala.com.cn/Lucene/Index/2020/0110/125.html)ä¸­ä»‹ç»ï¼Œä¸åœ¨æœ¬æ–‡ä¸­èµ˜è¿°ã€‚

## ç”Ÿæˆä¸€ä¸ªæˆ–å¤šä¸ªNodeBlockçš„æµç¨‹å›¾

å›¾2ï¼š

<img src="ç´¢å¼•æ–‡ä»¶çš„ç”Ÿæˆï¼ˆå…­ï¼‰-image/2.png">


### PendingEntryé›†åˆ

å›¾3ï¼š

<img src="ç´¢å¼•æ–‡ä»¶çš„ç”Ÿæˆï¼ˆå…­ï¼‰-image/3.png">

&emsp;&emsp;æˆ‘ä»¬åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­è¯´åˆ°ï¼Œtermæ ˆä¸­å­˜æ”¾äº†ä¸¤ç§ç±»å‹çš„ä¿¡æ¯ï¼šPendingTermå’ŒPendingBlockï¼Œå®ƒä»¬ä¸¤ä¸ªçš„ç±»å›¾å…³ç³»å¦‚ä¸‹æ‰€ç¤ºï¼š

å›¾4ï¼š

<img src="ç´¢å¼•æ–‡ä»¶çš„ç”Ÿæˆï¼ˆå…­ï¼‰-image/4.png">

&emsp;&emsp;æ•…å›¾2æµç¨‹å›¾çš„å‡†å¤‡æ•°æ®æ˜¯ä¸€ä¸ªPendingEntryé›†åˆï¼Œå®ƒå°±æ˜¯termæ ˆï¼ˆæœ¬äººå¯¹è¯¥é›†åˆçš„ç§°å‘¼ğŸ˜‚ï¼‰ï¼Œåœ¨æºç ä¸­å³pendingé“¾è¡¨ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

```java
    private final List<PendingEntry> pending = new ArrayList<>();
```
### ç”Ÿæˆä¸€ä¸ªæˆ–è€…å¤šä¸ªPendingBlockåˆ°newBlockä¸­

å›¾5ï¼š

<img src="ç´¢å¼•æ–‡ä»¶çš„ç”Ÿæˆï¼ˆå…­ï¼‰-image/5.png">

&emsp;&emsp;åœ¨ä»‹ç»è¯¥æµç¨‹ç‚¹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä¸‹PendingBlockç±»ä¸­çš„ä¸€äº›ä¿¡æ¯ï¼ŒPendingBlockç±»çš„å®šä¹‰å¦‚ä¸‹ï¼š

å›¾6ï¼š

<img src="ç´¢å¼•æ–‡ä»¶çš„ç”Ÿæˆï¼ˆå…­ï¼‰-image/6.png">

&emsp;&emsp;ç¬¬ä¸€æ¬¡æ‰§è¡Œå›¾2çš„æµç¨‹æ—¶ï¼ŒPendingEntryé›†åˆä¸­**æ€»æ˜¯**åªå­˜åœ¨PendingTermä¿¡æ¯ï¼Œé›†åˆä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ä»£è¡¨äº†ä¸€ä¸ªtermåŒ…å«çš„ä¿¡æ¯ï¼Œåœ¨æ‰§è¡Œå®Œå›¾2çš„æµç¨‹ä¹‹åï¼ŒPendingEntryé›†åˆä¸­çš„ä¿¡æ¯å°±è½¬åŒ–ä¸ºä¸€ä¸ªPendingBlockï¼ˆæˆ‘ä»¬è®°ä¸ºblock1ï¼‰ï¼Œå®ƒç”¨æ¥æè¿°å…·æœ‰ç›¸åŒå‰ç¼€çš„termé›†åˆçš„ä¿¡æ¯ï¼Œå¹¶ä¸”é‡æ–°æ·»åŠ åˆ°termæ ˆä¸­ï¼›å¦‚æœä¸‹ä¸€æ¬¡æ‰§è¡Œå›¾2çš„æµç¨‹æ—¶ï¼ŒPendingEntryé›†åˆä¸­åŒ…å«äº†PendingTermå’ŒPendingBlockï¼ˆblock1ï¼‰ä¸¤ç§ç±»å‹ä¿¡æ¯ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œå®Œå›¾2çš„æµç¨‹åï¼ŒPendingEntryé›†åˆä¸­çš„ä¿¡æ¯å°±ä¼šè½¬åŒ–ä¸ºä¸€ä¸ªæ–°çš„PendingBlockï¼ˆæˆ‘ä»¬è®°ä¸ºblock2ï¼‰ï¼Œç”±æ­¤å¯è§æ‰§è¡Œå›¾1çš„æµç¨‹ç‚¹`ç”Ÿæˆä¸€ä¸ªæˆ–å¤šä¸ªNodeBlock`å®é™…æ˜¯é€šè¿‡**åµŒå¥—**çš„æ–¹å¼å°†æ‰€æœ‰termçš„ä¿¡æ¯è½¬åŒ–ä¸ºä¸€ä¸ªPendingBlockã€‚

&emsp;&emsp;å›¾6ä¸­<font color=Red>çº¢æ¡†</font>æ ‡æ³¨çš„indexæè¿°çš„æ˜¯ä¸€ä¸ªPendingBlockè‡ªèº«çš„ä¿¡æ¯ï¼Œè€Œ<font color=Blue>è“æ¡†</font>æ ‡æ³¨çš„subIndicesæè¿°çš„æ˜¯è¯¥PendingBlockä¸­åµŒå¥—çš„PendingBlockä¿¡æ¯çš„é›†åˆï¼ˆå³æ¯ä¸€ä¸ªPendingBlockçš„indexä¿¡æ¯ï¼‰ï¼Œå¯¹äºblock1è·Ÿblock2æ¥è¯´ï¼Œblock2å¯¹è±¡ä¸­çš„subIndicesä¸­åŒ…å«äº†ä¸€æ¡ä¿¡æ¯ï¼Œè¯¥ä¿¡æ¯ä¸ºblock1ä¸­çš„indexä¿¡æ¯ï¼Œè‡³äºindexä¸­åŒ…å«äº†å…·ä½“å“ªäº›ä¿¡æ¯ï¼Œä¸‹æ–‡ä¸­ä¼šå±•å¼€ä»‹ç»ã€‚

&emsp;&emsp;æˆ‘ä»¬å›åˆ°`ç”Ÿæˆä¸€ä¸ªæˆ–è€…å¤šä¸ªPendingBlockåˆ°newBlockä¸­`çš„æµç¨‹ç‚¹çš„ä»‹ç»ã€‚

**ä¸ºä»€ä¹ˆå¯èƒ½ä¼šç”Ÿæˆå¤šä¸ªPendingBlock**

&emsp;&emsp;å¯¹äºå¾…å¤„ç†çš„PendingEntryé›†åˆï¼Œå®ƒåŒ…å«çš„ä¿¡æ¯æ•°é‡è‡³å°‘æœ‰minItemsInBlockä¸ªï¼ˆä¸ºä»€ä¹ˆä½¿ç”¨**è‡³å°‘**è¿™ä¸ªå‰¯è¯ï¼Œè§æ–‡ç« [ç´¢å¼•æ–‡ä»¶çš„ç”Ÿæˆï¼ˆäº”ï¼‰](https://www.amazingkoala.com.cn/Lucene/Index/2020/0110/125.html)ï¼‰ï¼Œå› ä¸ºè¿™æ˜¯å›¾2çš„æµç¨‹çš„è§¦å‘æ¡ä»¶ï¼Œå¦‚æœPendingEntryé›†åˆä¸­çš„æ•°é‡è¿‡å¤šï¼Œé‚£ä¹ˆéœ€è¦å¤„ç†ä¸ºå¤šä¸ªPendingBlockï¼Œè¿™ä¹ˆå¤„ç†çš„åŸå› ä»¥åŠå¤„ç†æ–¹å¼åœ¨æºç ä¸­ä¹Ÿç»™å‡ºäº†è§£é‡Šï¼Œè§ https://github.com/LuXugang/Lucene-7.5.0/blob/master/solr-7.5.0/lucene/core/src/java/org/apache/lucene/codecs/blocktree/BlockTreeTermsWriter.java ä¸­çš„ void writeBlocks(int prefixLength, int count)æ–¹æ³•ï¼š

```text
The count is too large for one block, so we must break it into "floor" blocks, where we record the leading label of the suffix of the first term in each floor block, so at search time we can jump to the right floor block.  We just use a naive greedy segmenter here: make a new floor block as soon as we have at least minItemsInBlock.  This is not always best: it often produces a too-small block as the final block:
```

&emsp;&emsp;ä¸Šè¿°çš„æ³¨é‡Šå¤§æ„ä¸ºï¼šå¦‚æœä¸€ä¸ªblockå¤ªå¤§ï¼Œé‚£ä¹ˆå°±åˆ’åˆ†ä¸ºå¤šä¸ªfloor blockï¼Œå¹¶ä¸”åœ¨æ¯ä¸ªfloor blockä¸­è®°å½•åç¼€çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ä½œä¸ºleading labelï¼Œä½¿å¾—åœ¨æœç´¢é˜¶æ®µèƒ½é€šè¿‡å‰ç¼€ä»¥åŠleading labelç›´æ¥è·³è½¬åˆ°å¯¹åº”çš„floor blockï¼Œå¦å¤–æ¯ç”Ÿæˆä¸€ä¸ªfloor blockï¼Œè¯¥blockä¸­è‡³å°‘åŒ…å«äº†minItemsInBlockæ¡PendingEntryä¿¡æ¯ï¼Œè¿™ç§åˆ’åˆ†æ–¹å¼é€šå¸¸ä¼šä½¿å¾—æœ€åä¸€ä¸ªblockä¸­åŒ…å«çš„ä¿¡æ¯æ•°é‡è¾ƒå°‘ã€‚

&emsp;&emsp;å¯¹äºä¸Šè¿°çš„æ³¨é‡Šæˆ‘ä»¬ä¼šæå‡ºä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š

- é—®é¢˜ä¸€ï¼šåˆ’åˆ†å‡ºä¸€ä¸ªfloor blockçš„è§„åˆ™æ˜¯ä»€ä¹ˆ
- é—®é¢˜äºŒï¼šåœ¨æœç´¢é˜¶æ®µï¼Œå¦‚ä½•é€šè¿‡å‰ç¼€è·Ÿleading labelå¿«é€Ÿè·³è½¬åˆ°å¯¹åº”floor block

**é—®é¢˜ä¸€ï¼šåˆ’åˆ†å‡ºä¸€ä¸ªfloor blockçš„è§„åˆ™æ˜¯ä»€ä¹ˆ**

&emsp;&emsp;ä½¿ç”¨ä¸‹é¢ä¸¤ä¸ªé˜ˆå€¼ä½œä¸ºåˆ’åˆ†å‚æ•°ï¼š

- minItemsInBlockï¼šé»˜è®¤å€¼ä¸º25
- maxItemsInBlockï¼šé»˜è®¤å€¼ä¸º48ï¼Œå®ƒçš„å€¼å¯ä»¥è®¾å®šçš„èŒƒå›´å¦‚ä¸‹æ‰€ç¤ºï¼š

```java
minItemsInBlock < maxItemsInBlock < 2*(minItemsInBlock-1)
```

&emsp;&emsp;åˆ’åˆ†çš„è§„åˆ™ï¼šæ¯å¤„ç†å›¾3ä¸­PendingEntryé›†åˆä¸­Nä¸ªä¿¡æ¯ï¼Œå°±ç”Ÿæˆä¸€ä¸ªblockï¼Œé™¤äº†ç¬¬ä¸€ä¸ªblockï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸ºhead blockï¼‰ï¼Œå…¶ä»–blockéƒ½æ˜¯floor blockï¼Œå…¶ä¸­Nå€¼ä¸å°äºminItemsInBlockï¼Œå¹¶ä¸”PendingEntryé›†åˆä¸­æœªå¤„ç†çš„ä¿¡æ¯ä¸å°äºmaxItemsInBlockï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

å›¾7ï¼š

<img src="ç´¢å¼•æ–‡ä»¶çš„ç”Ÿæˆï¼ˆå…­ï¼‰-image/7.png">

&emsp;&emsp;éšåå°†head blockä»¥åŠfloor blockä¸­åŒ…å«çš„PendingEntryä¿¡æ¯åˆ†åˆ«ç”ŸæˆPendingBlockï¼Œä¸¤ç§ç±»å‹çš„blockç”Ÿæˆçš„PendingBlockçš„å·®å¼‚æ€§ç”¨å›¾6ä¸­<font color=gray>é»‘ç°è‰²</font>æ ‡æ³¨çš„ä¸‰ä¸ªä¿¡æ¯æ¥åŒºåˆ†ï¼š

- prefixï¼šç›¸åŒå‰ç¼€ + leading labelï¼Œæ‰€æœ‰blockçš„ç›¸åŒå‰ç¼€éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå¯¹äºhead blockï¼Œå®ƒç”Ÿæˆçš„PendingBlockå¯¹åº”çš„prefixçš„å€¼åªæœ‰ç›¸åŒå‰ç¼€
- isFloorï¼šæ˜¯å¦ä¸ºfloor block
- floorLeadByteï¼šè¯¥å­—æ®µå³leading label

&emsp;&emsp;åœ¨ç”ŸæˆPendingBlockçš„è¿‡ç¨‹ä¸­ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å°†termä¿¡æ¯å†™å…¥åˆ°[ç´¢å¼•æ–‡ä»¶.timp](https://www.amazingkoala.com.cn/Lucene/suoyinwenjian/2019/0401/43.html)æ–‡ä»¶çš„è¿‡ç¨‹ï¼Œå³ç”ŸæˆNodeBlockçš„è¿‡ç¨‹ï¼Œå…¶ä¸­ä¸€ä¸ªblockï¼ˆhead blockæˆ–è€…floor blockï¼‰å¯¹åº”ç”Ÿæˆä¸€ä¸ªNodeBlockï¼Œä¸Šæ–‡ä¸­æˆ‘ä»¬è¯´åˆ°PendingEntryä¿¡æ¯å¯åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šPendingTermå’ŒPendingBlockï¼Œæ ¹æ®blockä¸­çš„ä¸åŒç±»å‹çš„PendingEntryï¼Œåœ¨ç´¢å¼•æ–‡ä»¶.timpä¸­å†™å…¥çš„æ•°æ®ç»“æ„ä¹Ÿæ˜¯ä¸åŒçš„ã€‚

#### blockä¸­åªåŒ…å«PendingTerm

å›¾8ï¼š

<img src="ç´¢å¼•æ–‡ä»¶çš„ç”Ÿæˆï¼ˆå…­ï¼‰-image/8.png">

&emsp;&emsp;æ ¹æ®blockä¸­åŒ…å«çš„PendingEntryçš„ç±»å‹ï¼Œå¯ä»¥ç»†åŒ–çš„å°†`blockä¸­åªåŒ…å«PendingTerm`å¯¹åº”ç”Ÿæˆçš„NodeBlockç§°ä¸ºOuterNodeï¼Œ`blockä¸­è‡³å°‘åŒ…å«PendingBlock`ï¼ˆè‡³å°‘åŒ…å«PendingBlockæ„æ€æ˜¯åªåŒ…å«PendingBlockæˆ–è€…åŒæ—¶åŒ…å«PendingBlockä»¥åŠPendingTermï¼‰å¯¹åº”ç”Ÿæˆçš„NodeBlockç§°ä¸ºInnerNodeã€‚

&emsp;&emsp;å›¾8ä¸­ï¼Œæ‰€æœ‰çš„å­—æ®µçš„å«ä¹‰å·²ç»åœ¨æ–‡ç« [ç´¢å¼•æ–‡ä»¶ä¹‹tim&&tip](https://www.amazingkoala.com.cn/Lucene/suoyinwenjian/2019/0401/43.html)ä»‹ç»ï¼Œä¸ä¸€ä¸€å±•å¼€ä»‹ç»ï¼Œè¿™é‡Œæ³¨æ„çš„æ˜¯<font color=Red>çº¢æ¡†</font>æ ‡æ³¨çš„8ä¸ªå­—æ®µæè¿°çš„æ˜¯ä¸€ä¸ªtermçš„ä¿¡æ¯ï¼Œè¯¥ä¿¡æ¯åœ¨ç”Ÿæˆ[ç´¢å¼•æ–‡ä»¶.doc](https://www.amazingkoala.com.cn/Lucene/suoyinwenjian/2019/0324/42.html)ã€[posã€.pay](https://www.amazingkoala.com.cn/Lucene/suoyinwenjian/2019/0324/41.html)ä¹‹åï¼Œä½¿ç”¨IntBlockTermStateå°è£…è¿™äº›ä¿¡æ¯ï¼Œå¹¶ä¸”é€šè¿‡åšä¸ºå›¾1ä¸­çš„å‡†å¤‡æ•°æ®å­˜å‚¨åˆ°ç´¢å¼•æ–‡ä»¶.timä¸­ï¼Œè¿™8ä¸ªå­—æ®µçš„ä»‹ç»è§æ–‡ç« [ç´¢å¼•æ–‡ä»¶çš„ç”Ÿæˆï¼ˆäº”ï¼‰ä¹‹tim&&tip](https://www.amazingkoala.com.cn/Lucene/Index/2020/0110/125.html)ã€‚

&emsp;&emsp;å½“outerNodeå†™å…¥åˆ°ç´¢å¼•æ–‡ä»¶.timä¹‹åï¼Œå®ƒåœ¨ç´¢å¼•æ–‡ä»¶ä¸­.timçš„èµ·å§‹ä½ç½®å°±ç”¨å›¾6çš„fpä¿¡æ¯æè¿°ï¼Œç”±äºblockä¸­å­˜åœ¨PendingTermï¼Œæ•…å›¾6ä¸­çš„hasTermsä¿¡æ¯è¢«ç½®ä¸ºtrueï¼Œè‡³æ­¤ï¼Œå›¾6ä¸­PendingBlockåŒ…å«çš„æ‰€æœ‰ä¿¡æ¯éƒ½å·²ç»ä»‹ç»å®Œæ¯•ï¼Œå¹¶ä¸”æˆ‘ä»¬ä¹Ÿæ˜ç™½äº†PendingBlockçš„ä½œç”¨ï¼šç”¨æ¥æè¿°ä¸€ä¸ªNodeBlockçš„æ‰€æœ‰ä¿¡æ¯ã€‚

#### blockä¸­è‡³å°‘åŒ…å«PendingBlock

&emsp;&emsp;æˆ‘ä»¬ç»“åˆä¸€ä¸ªä¾‹å­æ¥ä»‹ç»è¿™ç§æƒ…å†µã€‚

å›¾9ï¼š

<img src="ç´¢å¼•æ–‡ä»¶çš„ç”Ÿæˆï¼ˆå…­ï¼‰-image/9.png">

&emsp;&emsp;å¾…å¤„ç†çš„PendingEntryé›†åˆå¦‚å›¾9æ‰€ç¤ºï¼Œå…¶ä¸­é™¤äº†"ab"æ˜¯ä¸€ä¸ªPendingBlockï¼Œå…¶ä»–éƒ½æ˜¯PendingTermï¼Œå°†è¯¥PendingEntryé›†åˆç”Ÿæˆä¸€ä¸ªNodeBlockï¼Œå®ƒæ˜¯InnerNodeã€‚

å›¾10ï¼š

<img src="ç´¢å¼•æ–‡ä»¶çš„ç”Ÿæˆï¼ˆå…­ï¼‰-image/10.png">

&emsp;&emsp;ç”±å›¾10ä¸­<font color=Red>çº¢æ¡†</font>æ ‡æ³¨çš„ä¿¡æ¯æè¿°äº†PendingTermä»¥åŠPendingBlockå¯¹åº”çš„Suffixå­—æ®µçš„å·®å¼‚æ€§ï¼Œå¯¹äºPendingBlockï¼Œå®ƒå¯¹åº”çš„Suffixä¸­å¤šäº†ä¸€ä¸ªindexå­—æ®µï¼Œè¯¥å­—æ®µçš„å€¼å°±æ˜¯ä»¥"ab"ä¸ºå‰ç¼€çš„PendingBlockä¸­çš„fpä¿¡æ¯ï¼ˆå³å›¾6ä¸­çš„fpä¿¡æ¯ï¼‰ï¼Œå®ƒæè¿°äº†"ab"ä¸ºå‰ç¼€çš„PendingBlockå¯¹åº”çš„NodeBlockä¿¡æ¯åœ¨ç´¢å¼•æ–‡ä»¶.timä¸­çš„èµ·å§‹ä½ç½®ã€‚

&emsp;&emsp;æœ€åæ ¹æ®å›¾7ä¸­åˆ’åˆ†åçš„blockåœ¨åˆ†åˆ«ç”ŸæˆPendingBlockä¹‹åï¼Œå°†è¿™äº›PendingBlockæ·»åŠ åˆ°é“¾è¡¨newBlockä¸­ï¼ŒnewBlockçš„å®šä¹‰å¦‚ä¸‹ï¼š

```java
    private final List<PendingBlock> newBlocks = new ArrayList<>();
```

&emsp;&emsp;æ·»åŠ åˆ°é“¾è¡¨newBlockä¸­çš„ç›®çš„å°±æ˜¯ä¸ºä¸‹ä¸€ä¸ªæµç¨‹`åˆå¹¶PendingBlock`åšå‡†å¤‡çš„ã€‚

**é—®é¢˜äºŒï¼šåœ¨æœç´¢é˜¶æ®µï¼Œå¦‚ä½•é€šè¿‡å‰ç¼€è·Ÿleading labelå¿«é€Ÿè·³è½¬åˆ°å¯¹åº”floor block**

&emsp;&emsp;åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä»‹ç»ç´¢å¼•æ–‡ä»¶.tipæ—¶å›ç­”è¯¥é—®é¢˜ã€‚


### æ‰€æœ‰PendingBlockåˆå¹¶åˆ°ç¬¬ä¸€ä¸ªPendingBlock

å›¾11ï¼š

<img src="ç´¢å¼•æ–‡ä»¶çš„ç”Ÿæˆï¼ˆå…­ï¼‰-image/11.png">



&emsp;&emsp;åœ¨ä¸Šæ–‡ä¸­ï¼Œæ ¹æ®å›¾2ä¸­çš„PendingEntryé›†åˆï¼Œæˆ‘ä»¬ç”Ÿæˆäº†ä¸€ä¸ªæˆ–å¤šä¸ªPendingBlockï¼Œå¹¶ä¸”æ·»åŠ åˆ°äº†newBlockä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

å›¾12ï¼š

<img src="ç´¢å¼•æ–‡ä»¶çš„ç”Ÿæˆï¼ˆå…­ï¼‰-image/12.png">

&emsp;&emsp;åœ¨å½“å‰æµç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°†newBlockä¸­ç¬¬äºŒä¸ªPendingBlockå¼€å§‹åé¢æ‰€æœ‰çš„PendingBlockçš„ä¿¡æ¯åˆå¹¶åˆ°ç¬¬ä¸€ä¸ªPendingBlockä¸­ï¼Œåˆå¹¶çš„ä¿¡æ¯åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

- floorLeadByte
- fp
- hasTerms

&emsp;&emsp;éšåå°†è¿™äº›ä¿¡æ¯å†™å…¥åˆ°[FST](https://www.amazingkoala.com.cn/Lucene/yasuocunchu/2019/0220/35.html)ä¸­ï¼Œå…¶ä¸­ç›¸åŒå‰ç¼€å€¼ï¼ˆå³å›¾2ä¸­PendingEntryé›†åˆçš„æœ€é•¿ç›¸åŒå‰ç¼€å€¼ï¼‰ä½œä¸ºFSTçš„inputValueï¼Œåˆå¹¶çš„ä¿¡æ¯ä½œä¸ºFSTçš„outValueã€‚inputValueã€outValueçš„æ¦‚å¿µè§æ–‡ç« [FSTç®—æ³•ï¼ˆä¸Šï¼‰](https://www.amazingkoala.com.cn/Lucene/yasuocunchu/2019/0220/35.html)ï¼Œä¸èµ˜è¿°ã€‚

&emsp;&emsp;å›¾12ä¸­ï¼Œå¦‚æœ`blockä¸­è‡³å°‘åŒ…å«PendingBlock`ï¼Œé‚£ä¹ˆå¯¹åº”PendingBlockä¸­çš„subIndicesä¸­çš„ä¿¡æ¯ä¹Ÿéœ€è¦å†™å…¥åˆ°FSTä¸­ã€‚

### åˆå¹¶åçš„PendingBlockæ·»åŠ åˆ°termæ ˆ

å›¾13ï¼š

<img src="ç´¢å¼•æ–‡ä»¶çš„ç”Ÿæˆï¼ˆå…­ï¼‰-image/13.png">

&emsp;&emsp;æœ€ååˆå¹¶çš„PendingBlockæ·»åŠ åˆ°termæ ˆï¼Œç­‰å¾…è¢«åµŒå¥—åˆ°æ–°çš„PendingBlockä¸­ï¼Œæœ€ç»ˆï¼Œç»è¿‡å±‚å±‚çš„åµŒå¥—ï¼Œä¸€ä¸ªåŸŸä¸­äº§ç”Ÿçš„æ‰€æœ‰çš„PendingBlockéƒ½ä¼šè¢«åµŒå¥—åˆ°ä¸€ä¸ªPendingBlockä¸­ï¼Œè¯¥PendingBlockçš„indexä¿¡æ¯åœ¨åé¢çš„æµç¨‹ä¸­å°†ä¼šè¢«å†™å…¥åˆ°ç´¢å¼•æ–‡ä»¶.tipä¸­ã€‚

## ç»“è¯­

&emsp;&emsp;åŸºäºç¯‡å¹…ï¼Œå‰©ä½™çš„å†…å®¹å°†åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­å±•å¼€ã€‚

[ç‚¹å‡»](http://www.amazingkoala.com.cn/attachment/Lucene/Index/ç´¢å¼•æ–‡ä»¶çš„ç”Ÿæˆ/ç´¢å¼•æ–‡ä»¶çš„ç”Ÿæˆï¼ˆå…­ï¼‰/ç´¢å¼•æ–‡ä»¶çš„ç”Ÿæˆï¼ˆå…­ï¼‰.zip)ä¸‹è½½é™„ä»¶

